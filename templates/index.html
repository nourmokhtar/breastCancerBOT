<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Virtual Assistant</title>
    <style>
        #historyModal {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            border: 2px solid #333;
            padding: 20px;
            width: 60%;
            max-height: 70%;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        #historyModal h2 {
            margin-top: 0;
        }
        #closeModal {
            float: right;
            cursor: pointer;
            font-size: 18px;
            color: red;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 900;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Mental Health Assistant</h1>

    <textarea id="userInput" rows="4" cols="50" placeholder="How are you feeling?"></textarea><br>
    <button onclick="analyze()">Submit</button>

    <button onclick="startVoice()">üé§ Speak</button>
    <button onclick="stopVoice()">üõë Stop</button>
    <!-- Conversation History Section -->
   
    <button onclick="showHistory()">üìú Conversation History</button>

    <!-- History Modal -->
    <div id="overlay"></div>
    <div id="historyModal">
        <span id="closeModal" onclick="closeHistory()">‚úñ</span>
        <h2>Conversation History</h2>
        <pre id="historyContent">Loading...</pre>
        <button onclick="clearHistory()">üóëÔ∏è Clear History</button>
    </div>

    <script>
        // Show modal and fetch conversation history
        function showHistory() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("historyModal").style.display = "block";

            fetch("/recap")
            .then(res => res.json())
            .then(data => {
                document.getElementById("historyContent").textContent = data.recap || "No conversation history.";
            })
            .catch(err => {
                document.getElementById("historyContent").textContent = "‚ö†Ô∏è Error loading history.";
            });
        }

        // Close modal
        function closeHistory() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("historyModal").style.display = "none";
        }

        // Clear conversation history
        function clearHistory() {
            fetch("/clear_history", { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if (data.cleared) {
                    document.getElementById("historyContent").textContent = "‚úÖ History cleared.";
                } else {
                    document.getElementById("historyContent").textContent = "‚ö†Ô∏è Failed to clear history.";
                }
            })
            .catch(err => {
                document.getElementById("historyContent").textContent = "‚ö†Ô∏è Error clearing history.";
            });
        }
    </script>

    <h3>Detected Emotions (Text):</h3>
    <pre id="emotions">No emotion detected yet.</pre>

    <h3>Voice Transcription:</h3>
    <p id="transcription">No voice input yet.</p>

    <h3>LLM Text Response:</h3>
    <p id="textResponse">No response yet.</p>

    <h3>LLM Audio Response:</h3>
    <audio id="responseAudio" controls style="display:none;"></audio>
    <button id="replayBtn" onclick="replayAudio()" style="display:none;">üîÅ Replay</button>

    <h3>Select Camera:</h3>
    <select id="cameraSelect"></select>

    <h3>Live Emotion Detection (Webcam)</h3>
    <video id="videoFeed" width="480" height="360" autoplay muted></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <!-- New Button for Conversation History -->
    <hr>
    <button onclick="showHistory()">üìú Conversation History</button>

    <!-- History Modal -->
    <div id="overlay"></div>
    <div id="historyModal">
        <span id="closeModal" onclick="closeHistory()">‚úñ</span>
        <h2>Conversation History</h2>
        <pre id="historyContent">Loading...</pre>
        <button onclick="clearHistory()">üóëÔ∏è Clear History</button>
    </div>

    <!-- External scripts -->
    <script src="{{ url_for('static', filename='scripts/text_analysis.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/camera.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/face_analysis.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/voice.js') }}" defer></script>
    <script src="{{ url_for('static', filename='scripts/chat.js') }}" defer></script>

    <script>
        // To be called after audio generation
        function updateAudioResponse(audioFilename) {
            const audioElement = document.getElementById("responseAudio");
            const replayBtn = document.getElementById("replayBtn");
            audioElement.src = `/static/${audioFilename}`;
            audioElement.style.display = "block";
            replayBtn.style.display = "inline-block";
            audioElement.play().catch(e => {
                console.warn("üîá Audio playback failed:", e);
            });
        }

        function replayAudio() {
            const audio = document.getElementById("responseAudio");
            audio.currentTime = 0;
            audio.play();
        }

        // --- History modal functions ---
        function showHistory() {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("historyModal").style.display = "block";
            fetch("/recap")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("historyContent").textContent = data.recap || "No conversation history.";
                })
                .catch(err => {
                    document.getElementById("historyContent").textContent = "‚ö†Ô∏è Error loading history.";
                });
        }

        function closeHistory() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("historyModal").style.display = "none";
        }

        function clearHistory() {
            fetch("/clear_history", {method: "POST"})
                .then(res => res.json())
                .then(data => {
                    if (data.cleared) {
                        document.getElementById("historyContent").textContent = "‚úÖ History cleared.";
                    } else {
                        document.getElementById("historyContent").textContent = "‚ö†Ô∏è Failed to clear history.";
                    }
                })
                .catch(err => {
                    document.getElementById("historyContent").textContent = "‚ö†Ô∏è Error clearing history.";
                });
        }
    </script>
</body>
</html>
